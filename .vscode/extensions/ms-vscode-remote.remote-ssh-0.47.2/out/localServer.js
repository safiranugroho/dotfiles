!function(e,t){for(var n in t)e[n]=t[n]}(exports,function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=1135)}({11:function(e,t){e.exports=require("fs")},1135:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(47),o=n(74),s=n(11),i=n(17),u=n(9),c=n(39),a=JSON.parse(process.argv[2]);let d=!1;function l(e,t,n,r){t.writeHead(n,{"Content-Type":"text/plain"}),t.end(r)}function p(e){console.log(c.markLines(e,"local-server"))}function f(e){console.error(c.markLines(e,"local-server"))}class h{constructor(){this.child=h.spawnSsh()}dispose(){this.child.kill()}static spawnSsh(){const e=r.spawn(a.sshCommand,a.sshArgs,{stdio:["inherit","pipe","pipe"],windowsHide:!0});let t=!1;return e.stdout.on("data",e=>{t||process.stdout.write(e),e.toString().includes(": end")&&(t=!0)}),e.stderr.on("data",e=>{process.stderr.write(e)}),e.on("exit",()=>{d||(p("ssh child died, shutting down"),process.exit(0))}),p("Spawned "+e.pid),e}}const m=new class{constructor(e){this.ipcHandlePath=e,this.server=i.createServer((e,t)=>this.onRequest(e,t));try{this.server.listen(this.ipcHandlePath),this.server.on("error",e=>f(e.message))}catch(e){f("Could not launch management server."),process.exit(1)}this.delayShutdown()}delayShutdown(){this.shutdownTimer&&clearTimeout(this.shutdownTimer),this.shutdownTimer=setTimeout(()=>{this.dispose(),w(),p("Timed out"),process.exit(0)},5e3)}onRequest(e,t){if("GET"!==e.method)return t.writeHead(405,{"Content-Type":"text/plain"}),t.end(`Unsupported method ${e.method}`);if(!e.url)return l(0,t,400,"Bad request.");const n=u.parse(e.url,!0).pathname;return n?("/delay-shutdown"===n&&(this.delayShutdown(),t.writeHead(200),t.end("OK")),t.writeHead(404,{"Content-Type":"text/plain"}),t.end("Not found")):l(0,t,400,"Bad request.")}dispose(){this.server.close()}}(a.ipcHandlePath),y=new h;function w(){if(d=!0,m.dispose(),y.dispose(),s.existsSync(a.dataFilePath))try{const e=s.readFileSync(a.dataFilePath);JSON.parse(e.toString()).pid===process.pid&&s.unlinkSync(a.dataFilePath)}catch(e){}}process.on("exit",()=>{w()}),process.on("SIGTERM",()=>{w(),process.exit(o.SIGTERM)})},17:function(e,t){e.exports=require("http")},32:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isWindows="win32"===process.platform},39:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(32);function o(e){return e.replace(/\x1b\[\??[0-9]{0,3}(;[0-9]{1,3})?[a-zA-Z]/g,"").replace(/\r/g,"")}function s(e){return`"${e}"`}function i(e){return e.replace(/\r?\n$/,"")}t.lastNonemptyLine=function(e){const t=e.split("\n");if(r.isWindows)for(let e=t.length-1;e>=0;e--){const n=o(t[e]);if(n)return n}const n=t.filter(e=>!!e);return n[n.length-1]},t.stripEscapeSequences=o,t.quote=s,t.quoteForCommand=function(e){return e.match(/[ \(\)]/)?s(e):e},t.stripTrailingNewline=i,t.markLines=function(e,t=""){return i(e).split(/\n/).map(e=>`${t}> ${e}`).join("\n")},t.escapeRegExpCharacters=function(e){return e.replace(/[\\\{\}\*\+\?\|\^\$\.\[\]\(\)]/g,"\\$&")}},47:function(e,t){e.exports=require("child_process")},74:function(e,t){e.exports=require("constants")},9:function(e,t){e.exports=require("url")}}));
//# sourceMappingURL=localServer.js.map